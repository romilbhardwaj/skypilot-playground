resources:
  cloud: gcp
  ports: 80

# API URL for SkyPilot authentication
envs:
  API_URL: 
  PLAYGROUND_PASSWORD: 

workdir: .

file_mounts:
  ~/nginx_config: ./default

setup: |
  # Install ttyd
  wget https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64
  sudo mv ttyd.x86_64 /usr/local/bin/ttyd
  sudo chmod +x /usr/local/bin/ttyd
  
  # Install nginx and apache2-utils
  sudo apt-get update
  sudo apt-get install -y nginx apache2-utils

  # Add user and password
  sudo htpasswd -c -b /etc/nginx/.htpasswd skypilot ${PLAYGROUND_PASSWORD}
  
  # Copy nginx config to /etc/nginx/sites-available/default
  sudo cp ~/nginx_config /etc/nginx/sites-available/default
  
  # Restart nginx
  sudo systemctl restart nginx
  
  # Build docker image
  docker build --build-arg API_URL=${API_URL} -t skypilot-playground .

run: |
  # Run docker image
  ttyd --writable --max-clients 16 docker run --rm -it skypilot-playground /bin/bash

